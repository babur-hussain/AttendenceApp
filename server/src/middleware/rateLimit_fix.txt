60,64c60,63
<     // Clean up old entries
<     db.getConnection()
<       .prepare('DELETE FROM rate_limits WHERE window_start < ?')
<       .run(windowStart.toISOString());
< 
---
>     // Clean up old entries
>     await db.run('DELETE FROM rate_limits WHERE window_start < ?', [windowStart.toISOString()]);
> 
>     // Get current count
66,75c65,69
<     const currentRecord = db
<       .getConnection()
<       .prepare(`
<         SELECT request_count
<         FROM rate_limits
<         WHERE device_id = ? AND endpoint = ? AND window_start >= ?
<       `)
<       .get(deviceId, endpoint, windowStart.toISOString()) as
<         | { request_count: number }
<         | undefined;
---
>     const currentRecord = await db.get<{ request_count: number }>(
>       'SELECT request_count FROM rate_limits WHERE device_id = ? AND endpoint = ? AND window_start >= ?',
>       [deviceId, endpoint, windowStart.toISOString()]
>     );
> 
101,112c95,100
<       db.getConnection()
<         .prepare(`
<           INSERT INTO rate_limits (device_id, endpoint, request_count, window_start)
<           VALUES (?, ?, 1, ?)
<         `)
<         .run(deviceId, endpoint, windowStart.toISOString());
<     } else {
<       // Increment existing count
<       db.getConnection()
<         .prepare(`
<           UPDATE rate_limits SET request_count = request_count + 1 WHERE device_id = ? AND endpoint = ?
<         `)
<         .run(deviceId, endpoint);
---
>       await db.run(
>         'INSERT INTO rate_limits (device_id, endpoint, request_count, window_start) VALUES (?, ?, 1, ?)',
>         [deviceId, endpoint, windowStart.toISOString()]
>       );
>     } else {
>       await db.run('UPDATE rate_limits SET request_count = request_count + 1 WHERE device_id = ? AND endpoint = ?', [deviceId, endpoint]);
